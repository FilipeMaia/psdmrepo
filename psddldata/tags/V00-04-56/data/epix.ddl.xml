<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE psddl SYSTEM "psddl.dtd">

<psddl>
    <package name="Epix">


        <!-- ========================================================================= -->
        <pstype name="AsicConfigV1" version="1" pack="4">
        
            <attribute name="_reg1" type="uint32_t">
                <bitfield name="_monostPulser" size="3"  type="uint8_t" accessor="monostPulser" />
                <bitfield name="_z"            size="29" type="uint32_t" />
            </attribute>
            <attribute name="_reg2" type="uint32_t">
                 <bitfield name="_dummyTest"   size="1" type="uint8_t" accessor="dummyTest" />
                 <bitfield name="_dummyMask"   size="1" type="uint8_t" accessor="dummyMask" />
                 <bitfield name="_z"       size="30" type="uint32_t" />
            </attribute>
            <attribute name="_reg3" type="uint32_t">
                <bitfield name="_pulser"  size="10" type="uint16_t" accessor="pulser" />
                <bitfield name="_pbit"    size="1"  type="uint8_t"  accessor="pbit" />
                <bitfield name="_atest"   size="1"  type="uint8_t"  accessor="atest" />
                <bitfield name="_test"    size="1"  type="uint8_t"  accessor="test" />
                <bitfield name="_sabTest" size="1"  type="uint8_t"  accessor="sabTest" />
                <bitfield name="_hrTest"  size="1"  type="uint8_t"  accessor="hrTest" />
                <bitfield name="_z"       size="17" type="uint32_t" />
            </attribute>
            <attribute name="_reg4" type="uint32_t">
                <bitfield name="_digMon1" size="4"  type="uint8_t" accessor="digMon1" />
                <bitfield name="_digMon2" size="4"  type="uint8_t" accessor="digMon2" />
                <bitfield name="_z"       size="24" type="uint32_t" />
            </attribute>
            <attribute name="_reg5" type="uint32_t">
                <bitfield name="_pulserDac" size="3"   type="uint8_t" accessor="pulserDac" />
                <bitfield name="_z"         size="29" type="uint32_t" />
            </attribute>
            <attribute name="_reg6" type="uint32_t">
                <bitfield name="_Dm1En"    size="1"  type="uint8_t" accessor="Dm1En" />
                <bitfield name="_Dm2En"    size="1"  type="uint8_t" accessor="Dm2En" />
                <bitfield name="_z1"       size="2"  type="uint8_t" />
                <bitfield name="_slvdSBit" size="1"  type="uint8_t" accessor="slvdSBit" />
                <bitfield name="_z2"       size="27" type="uint32_t" />
            </attribute>
            <attribute name="_reg7" type="uint32_t">
                <bitfield name="_VRefDac" size="6"  type="uint8_t" accessor="VRefDac" />
                <bitfield name="_z"    size="29" type="uint32_t" />
            </attribute>
            <attribute name="_reg8" type="uint32_t">
                <bitfield name="_TpsTComp" size="1"    type="uint8_t" accessor="TpsTComp" />
                <bitfield name="_TpsMux"   size="4"    type="uint8_t" accessor="TpsMux" />
                <bitfield name="_RoMonost" size="3"    type="uint8_t" accessor="RoMonost" />
                <bitfield name="_z"        size="24"   type="uint32_t" />
            </attribute>
            <attribute name="_reg9" type="uint32_t">
                <bitfield name="_TpsGr"    size="4"  type="uint8_t" accessor="TpsGr" />
                <bitfield name="_S2dGr"    size="4"  type="uint8_t" accessor="S2dGr" />
                <bitfield name="_z"        size="24" type="uint32_t" />
            </attribute>
            <attribute name="_reg10" type="uint32_t">
                <bitfield name="_PpOcbS2d"     size="1"    type="uint8_t" accessor="PpOcbS2d" />
                <bitfield name="_Ocb"          size="3"    type="uint8_t" accessor="Ocb" />
                <bitfield name="_Monost"       size="3"    type="uint8_t" accessor="Monost" />
                <bitfield name="_FastppEnable" size="1"    type="uint8_t" accessor="FastppEnable" />
                <bitfield name="_z"            size="24"   type="uint32_t" />
            </attribute>
            <attribute name="_reg11" type="uint32_t">
                <bitfield name="_Preamp"       size="3"   type="uint8_t" accessor="Preamp" />
                <bitfield name="_z1"           size="1"   type="uint8_t" />
                <bitfield name="_PixelCb"      size="3"   type="uint8_t" accessor="PixelCb" />
                <bitfield name="_z2"           size="25"  type="uint32_t" />
            </attribute>
            <attribute name="_reg12" type="uint32_t">
                <bitfield name="_S2dTComp"     size="1"    type="uint8_t" accessor="S2dTComp" />
                <bitfield name="_FilterDac"    size="6"    type="uint8_t" accessor="FilterDac" />
                <bitfield name="_z"            size="25"   type="uint32_t" />
            </attribute>
            <attribute name="_reg13" type="uint32_t">
                <bitfield name="_TC"           size="2"   type="uint8_t" accessor="TC" />
                <bitfield name="_S2d"          size="3"   type="uint8_t" accessor="S2d" />
                <bitfield name="_S2dDacBias"   size="3"   type="uint8_t" accessor="S2dDacBias" />
                <bitfield name="_z"            size="25"   type="uint32_t" />
            </attribute>
            <attribute name="_reg14" type="uint32_t">
                <bitfield name="_TpsTcDac"    size="2"   type="uint8_t" accessor="TpsTcDac" />
                <bitfield name="_TpsDac"      size="6"   type="uint8_t" accessor="TpsDac" />
                <bitfield name="_z"            size="24"  type="uint32_t" />
            </attribute>
            <attribute name="_reg15" type="uint32_t">
                <bitfield name="_S2dTcDac"    size="2"   type="uint8_t" accessor="S2dTcDac" />
                <bitfield name="_S2dDac"      size="6"   type="uint8_t" accessor="S2dDac" />
                <bitfield name="_z"           size="24"  type="uint32_t" />
            </attribute>
            <attribute name="_reg16" type="uint32_t">
                <bitfield name="_TestBe"    size="1"   type="uint8_t" accessor="TestBe" />
                <bitfield name="_IsEn"      size="1"   type="uint8_t" accessor="IsEn" />
                <bitfield name="_DelExec"   size="1"   type="uint8_t" accessor="DelExec" />
                <bitfield name="_DelCckReg" size="1"   type="uint8_t" accessor="DelCckReg" />
                <bitfield name="_z"         size="28"  type="uint32_t" />
            </attribute>
            <attribute name="_reg17" type="uint32_t">
                <bitfield name="_RowStartAddr" size="9"  type="uint16_t" accessor="RowStartAddr" />
                <bitfield name="_z"            size="23" type="uint32_t" />
            </attribute>
            <attribute name="_reg18" type="uint32_t">
                <bitfield name="_RowStopAddr"  size="9"  type="uint16_t" accessor="RowStopAddr" />
                <bitfield name="_z"            size="23" type="uint32_t" />
            </attribute>
            <attribute name="_reg19" type="uint32_t">
                <bitfield name="_ColStartAddr" size="7"  type="uint8_t" accessor="ColStartAddr" />
                <bitfield name="_z"            size="25" type="uint32_t" />
            </attribute>
            <attribute name="_reg20" type="uint32_t">
                <bitfield name="_ColStopAddr"  size="7"  type="uint8_t" accessor="ColStopAddr" />
                <bitfield name="_z"            size="25" type="uint32_t" />
            </attribute>
            <attribute name="_reg21" type="uint32_t">
                <bitfield name="_chipID"  size="16" type="uint16_t" accessor="chipID" />
                <bitfield name="_z"       size="16" type="uint16_t" />
            </attribute>

            <ctor>
              Default constructor
              <tag name="inline"/>
            </ctor>

            <ctor>
              Constructor with value for each attribute
              <tag name="auto"/>
            </ctor>

        </pstype>
        
        
        <!-- ========================================================================= -->
        <pstype name="ConfigV1" version="1" type_id="Id_EpixConfig" pack="4">
        
            <tag name="config-type"/>
        
            <attribute name="_version"          type="uint32_t" accessor="version" />
            <attribute name="_runTrigDelay"     type="uint32_t" accessor="runTrigDelay" />
            <attribute name="_daqTrigDelay"     type="uint32_t" accessor="daqTrigDelay" />
            <attribute name="_dacSetting"       type="uint32_t" accessor="dacSetting" />
            <attribute name="_asicPins"         type="uint32_t" >
                <bitfield name="_asicGR"      size="1"  type="uint8_t" accessor="asicGR" />
                <bitfield name="_asicAcq"     size="1"  type="uint8_t" accessor="asicAcq" />
                <bitfield name="_asicR0"      size="1"  type="uint8_t" accessor="asicR0" />
                <bitfield name="_asicPpmat"   size="1"  type="uint8_t" accessor="asicPpmat" />
                <bitfield name="_asicPpbe"    size="1"  type="uint8_t" accessor="asicPpbe" />
                <bitfield name="_asicRoClk"   size="1"  type="uint8_t" accessor="asicRoClk" />
                <bitfield name="_z"           size="26" type="uint32_t"   />  
            </attribute>
            <attribute name="_asicControls"     type="uint32_t" >
                <bitfield name="_asicGRControl"     size="1"  type="uint8_t"  accessor="asicGRControl" />
                <bitfield name="_asicAcqControl"    size="1"  type="uint8_t"  accessor="asicAcqControl" />
                <bitfield name="_asicR0Control"     size="1"  type="uint8_t"  accessor="asicR0Control" />
                <bitfield name="_asicPpmatControl"  size="1"  type="uint8_t"  accessor="asicPpmatControl" />
                <bitfield name="_asicPpbeControl"   size="1"  type="uint8_t"  accessor="asicPpbeControl" />
                <bitfield name="_asicR0ClkControl"  size="1"  type="uint8_t"  accessor="asicR0ClkControl" />
                <bitfield name="_prepulseR0En"      size="1"  type="uint8_t"  accessor="prepulseR0En" />
                <bitfield name="_adcStreamMode"     size="1"  type="uint32_t" accessor="adcStreamMode"  /> 
                <bitfield name="_testPatternEnable" size="1"  type="uint8_t"  accessor="testPatternEnable" />
                <bitfield name="_z1"                size="23" type="uint8_t"     />
            </attribute>
            <attribute name="_acqToAsicR0Delay"   type="uint32_t" accessor="acqToAsicR0Delay" />
            <attribute name="_asicR0ToAsicAcq"    type="uint32_t" accessor="asicR0ToAsicAcq" />
            <attribute name="_asicAcqWidth"       type="uint32_t" accessor="asicAcqWidth" />
            <attribute name="_asicAcqLToPPmatL"   type="uint32_t" accessor="asicAcqLToPPmatL" />
            <attribute name="_asicRoClkHalfT"     type="uint32_t" accessor="asicRoClkHalfT" />
            <attribute name="_adcReadsPerPixel"   type="uint32_t" accessor="adcReadsPerPixel" />
            <attribute name="_adcClkHalfT"        type="uint32_t" accessor="adcClkHalfT" />
            <attribute name="_asicR0Width"        type="uint32_t" accessor="asicR0Width" />
            <attribute name="_adcPipelineDelay"   type="uint32_t" accessor="adcPipelineDelay" />
            <attribute name="_prepulseR0Width"    type="uint32_t" accessor="prepulseR0Width" />
            <attribute name="_prepulseR0Delay"    type="uint32_t" accessor="prepulseR0Delay" />
            <attribute name="_digitalCardId0"     type="uint32_t" accessor="digitalCardId0" />
            <attribute name="_digitalCardId1"     type="uint32_t" accessor="digitalCardId1" />
            <attribute name="_analogCardId0"      type="uint32_t" accessor="analogCardId0" />
            <attribute name="_analogCardId1"      type="uint32_t" accessor="analogCardId1" />
            <attribute name="_lastRowExclusions"  type="uint32_t" accessor="lastRowExclusions" />
            <attribute name="_numberOfAsicsPerRow"       type="uint32_t" accessor="numberOfAsicsPerRow" />
            <attribute name="_numberOfAsicsPerColumn"    type="uint32_t" accessor="numberOfAsicsPerColumn" />
                        generally 2x2
            <attribute name="_numberOfRowsPerAsic"       type="uint32_t" accessor="numberOfRowsPerAsic" />
                        for epix100 352
                        for epix10k 176
            <attribute name="_numberOfPixelsPerAsicRow"  type="uint32_t" accessor="numberOfPixelsPerAsicRow" />
                        for epix100 96*4
                        for epix10k 48*4
            <attribute name="_baseClockFrequency" type="uint32_t" accessor="baseClockFrequency" />
            <attribute name="_asicMask"           type="uint32_t" accessor="asicMask" />
            <attribute name="_asics" type="AsicConfigV1" shape="{self}.numberOfAsicsPerRow()*{self}.numberOfAsicsPerColumn()" accessor="asics" />

            <attribute name="_asicPixelTestArray" type="uint32_t"
                    shape="{self}.numberOfAsicsPerRow()*{self}.numberOfAsicsPerColumn(), {self}.numberOfRowsPerAsic(), ({self}.numberOfPixelsPerAsicRow()+31)/32"
                    accessor="asicPixelTestArray">
            </attribute>

            <attribute name="_asicPixelMaskArray" type="uint32_t"
                    shape="{self}.numberOfAsicsPerRow()*{self}.numberOfAsicsPerColumn(), {self}.numberOfRowsPerAsic(), ({self}.numberOfPixelsPerAsicRow()+31)/32"
                    accessor="asicPixelMaskArray">
            </attribute>

            <ctor>
                Default constructor
                <tag name="inline"/>
            </ctor>
            <ctor>
                Constructor which takes values for every attribute
                <tag name="auto"/>
            </ctor>
	       <ctor>
	       	 Constructor which takes values necessary for size calculations
	       	 <tag name="inline"/>
                <arg name="numberOfAsicsPerRow"      dest="_numberOfAsicsPerRow"/>
                <arg name="numberOfAsicsPerColumn"   dest="_numberOfAsicsPerColumn"/>
                <arg name="numberOfRowsPerAsic"      dest="_numberOfRowsPerAsic"/>
                <arg name="numberOfPixelsPerAsicRow" dest="_numberOfPixelsPerAsicRow"/>
           </ctor>

            <method name="numberOfRows"     type="uint32_t">
                Number of rows in a readout unit
                <tag name="inline"/>
                <expr lang="C++"  value="{self}.numberOfAsicsPerColumn()*{self}.numberOfRowsPerAsic() - {self}.lastRowExclusions()" />
            </method>

            <method name="numberOfColumns"  type="uint32_t">
                Number of columns in a readout unit
                <tag name="inline"/>
                <expr lang="C++"  value=" {self}.numberOfAsicsPerRow()*{self}.numberOfPixelsPerAsicRow()" />
            </method>

            <method name="numberOfAsics"  type="uint32_t">
                Number of columns in a readout unit
                <tag name="inline"/>
                <expr lang="C++"  value=" {self}.numberOfAsicsPerRow()*{self}.numberOfAsicsPerColumn()" />
            </method>

        </pstype>
        
        <!-- ========================================================================= -->
        
        <pstype name="ElementV1" version="1" type_id="Id_EpixElement" pack="2">
        
            <xtc-config name="ConfigV1" />

            <attribute name="_first" type="uint32_t">
                <bitfield name="_vc" size="2" type="uint8_t" accessor="vc" />
                <bitfield name="_z" size="4" type="uint8_t" />
                <bitfield name="_lane" size="2" type="uint8_t" accessor="lane" />
                <bitfield name="_tid" size="24" type="uint32_t" />
            </attribute>

            <attribute name="_second" type="uint32_t">
		        <bitfield name="_acqCount" size="16" type="uint16_t"  accessor="acqCount" />
		        <bitfiled name="_z"	       size="16" type="uint16_t" />
           </attribute>
 
            <attribute name="_frameNumber" type="uint32_t" accessor="frameNumber" />
            <attribute name="_ticks" type="uint32_t" accessor="ticks" />
            <attribute name="_fiducials" type="uint32_t" accessor="fiducials" />
            <attribute name="_z0" type="uint32_t" />
            <attribute name="_z1" type="uint32_t" />
            <attribute name="_z2" type="uint32_t" />
            <attribute name="_frame" type="uint16_t" shape="{xtc-config}.numberOfRows(),{xtc-config}.numberOfColumns()" accessor="frame" />
            Frame is 2x2 asics, 
            which for epix100 is 352*2 rows by 96*4*2 columns, 
                or 704 rows by 768 columns, 
                or 540672 pixels
            which for epix10k is 176*2 rows by 48*4*2 columns,
                or 352 rows by 384 columns
                or 135168 pixels
            each pixel is a uint16_t
           <attribute name="_excludedRows" type="uint16_t" shape="{xtc-config}.lastRowExclusions(),{xtc-config}.numberOfColumns()" accessor="excludedRows" />
           <attribute name="_temperatures" type="uint16_t" shape="{xtc-config}.numberOfAsics()" accessor="temperatures" />
           <attribute name="_lastWord" type="uint32_t" accessor="lastWord" />
        </pstype>
        
        
    </package>
</psddl>
