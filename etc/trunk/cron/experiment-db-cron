#!/bin/sh

db=/reg/g/psdm/data/ExpNameDb/experiment-db.dat
tmpdb=$db.tmp
rpmsrc=/reg/g/psdm/sw/dist/rpms/SOURCES

q="select e.id, i.name, e.name from experiment e, instrument i where e.instr_id = i.id and INSTR(e.name, ' ') = 0 order by e.id;"

echo "$q" | mysql -N -hpsdb -uregdb_reader regdb > $tmpdb
if diff -q $tmpdb $db > /dev/null ; then
	rm $tmpdb
else
	mv $tmpdb $db
	echo "$db has been updated"
	
	# make a tarball
	cd /reg/g/psdm
	ts=$(date +%Y%m%d)
	tar czf /tmp/psdm-data-$ts.tar.gz data
	mv /tmp/psdm-data-$ts.tar.gz $rpmsrc/
	echo "Created tarball $rpmsrc/psdm-data-$ts.tar.gz"

fi
