#!/bin/sh
#
# $Id$
#
# Script for convenient checkout of the packages from repository
#


usage() {
  cat << EOD

Usage: $0 [options] [package-name [package-tag]]

  Available options:
    -h          this message
    -d          debug (turn on -x shell option)
    -c          checkout from CVS [default is SVN]
    -f {file|-} read the list of tags from file or standard input

  Checks out the packages from repository, the tag can be either a real 
tag in repository or "HEAD" for main trunk. If tag is missing then the
tag from the base release is used, or HEAD if package is not in the release.  
If package name is SConsTools then link SConstruct to SConstruct.main in the
package's src/ directory.

EOD
}

find_tag() {

  pkg="$1"
  tag="$2"
  rel="$3"

  if [ -z "$tag" ] ; then
    #tag=`statusrel "$rel" "$pkg"`
    tag="HEAD"
    if [ -z "$tag" ] ; then
      tag="HEAD"
      echo "Release $rel does not have package $pkg, will use HEAD version" 1>&2
    else
      echo "Release $rel has tag $tag of package $pkg, will use that" 1>&2
    fi
  fi
  echo "$tag"
}

checkout() {

  pkg="$1"
  tag="$2"
  rel="$3"
  mode="$4"
  
  # get the real tag
  tag=`find_tag "$pkg" "$tag" "$rel"`

  # checkout package
  if [ "$mode" = "cvs" ] ; then
    checkout_cvs "$pkg" "$tag" || exit 2
  else
    checkout_svn "$pkg" "$tag" || exit 2
  fi

  # link or copy SConstruct file
  if [ "$pkg" = "SConsTools" ] ; then
    scons="SConstruct"
    test -h "$scons" && rm "$scons"
    test -f "$scons" && mv "$scons" "$scons.save"
    echo "Linking $scons to $pkg/src/$scons.main"
    ln -s "$pkg/src/$scons.main" "$scons"
  fi


}

checkout_cvs() {

  pkg="$1"
  tag="$2"

  if [ "$tag" = "HEAD" ] ; then
    cvs checkout "$pkg"
  else
    cvs checkout -r "$tag" "$pkg"
  fi

}

checkout_svn() {

  pkg="$1"
  tag="$2"

  repo="$SVNROOT/$pkg/trunk"
  test "$tag" = "HEAD" || repo="$SVNROOT/$pkg/tags/$tag"

  # for existing packages use "switch"
  if [ -d "$pkg" ] ; then
    svn switch "$repo" "$pkg"
  else
    svn checkout "$repo" "$pkg"
  fi

}

# default values for options
mode="svn"
link_scons="no"
tag_file=""

# get the options
while getopts hdcf: c ; do
  case $c in
    h) usage ; exit 0 ;;
    d) set -x ;;
    c) mode="cvs" ;;
    f) tag_file="$OPTARG" ;;
    \?) usage ; exit 2 ;;
  esac
done
shift `expr $OPTIND - 1`

# check arguments
if [ -z "$tag_file" ] ; then
  if [ $# -eq 0 -o $# -gt 2 ] ; then
    usage
    exit 2
  fi
else
  if [ $# -ne 0 ] ; then
    usage
    exit 2
  fi
fi

# the file .lusi_release must be in the current directory
if [ ! -f .lusi_release ] ; then
  echo "Release not setup, file .lusi_release does not exist in current directory"
  exit 2
fi

if [ "$mode" = "cvs" ] ; then
  if [ -z "$CVSROOT" ] ; then
    echo "CVSROOT environment variable is not defined"
    exit 2
  fi
else
  if [ -z "$SVNROOT" ] ; then
    echo "SVNROOT environment variable is not defined"
    exit 2
  fi
fi

# get the base release name
lusi_release=`cat .lusi_release | tr -d ' '`

if [ "$tag_file" = '-' ] ; then

  # read tags from stdin, one line at a time
  while read pkg tag stuff ; do
    echo addpkg "$pkg" "$tag"
    checkout "$pkg" "$tag" "$lusi_release" "$mode"
  done

elif [ -n "$tag_file" ] ; then

  # read tags from file, one line at a time
  while read pkg tag stuff ; do
    echo addpkg "$pkg" "$tag"
    checkout "$pkg" "$tag" "$lusi_release" "$mode"
  done < "$tag_file"

else

  # package name and optionally tag come from command line
  pkg=`echo $1 | cut -d/ -f1`
  tag="$2"
  checkout "$pkg" "$tag" "$lusi_release" "$mode"
    
fi
  
