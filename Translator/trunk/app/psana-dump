#!@PYTHON@

import sys
import os
import tempfile

usage='''** Wrapper to the psana Dumping modules
Run as:
   %s [psana arguments] [--epics] [--epix] [--rayonix] [--onlyEpics]

By default all dumpers execpt epics, epics and rayonix are loaded.
Add the options to load those.  Set --onlyEpics to only dump epics.
''' % (os.path.basename(sys.argv[0]), )

args = sys.argv[1:]
if len(args)==0 or args[0] == '-h' or args[0]=='--help':
  print usage
  sys.exit(0)

psanaArgs = []
while len(args)>0:
  if args[0] in ['--epics', '--epix', '--rayonix', '--onlyEpics']:
    break
  psanaArgs.append(args.pop(0))

dumpEpics = '--epics' in args
dumpRayonix = '--rayonix' in args
dumpEpix = '--epix' in args
onlyEpics = '--onlyEpics' in args

if set(args).difference(set(['--epics', '--epix', '--rayonix', '--onlyEpics'])):
  print "ERROR: only --epics, --epix, --rayonix or --onlyEpics can follow psana args"
  print usage
  sys.exit(1)

if onlyEpics:
  dumpEpics = False
  dumpRayonix = False
  dumpEpix = False

cfg = tempfile.NamedTemporaryFile(suffix='.cfg',prefix='psana-dump_')
cfg.write("[psana]\n")
if not onlyEpics:
  cfg.write("modules = psana_examples.DumpAcqTdc psana_examples.DumpAcqiris psana_examples.DumpAlias psana_examples.DumpAndor psana_examples.DumpBld psana_examples.DumpCamera psana_examples.DumpControl psana_examples.DumpCsPad psana_examples.DumpCsPad2x2 psana_examples.DumpEncoder  psana_examples.DumpEvr psana_examples.DumpFccd psana_examples.DumpFli psana_examples.DumpGsc16ai psana_examples.DumpImp psana_examples.DumpIpimb psana_examples.DumpL3T psana_examples.DumpLusi psana_examples.DumpOceanOptics psana_examples.DumpOpal1k psana_examples.DumpOrca psana_examples.DumpPnccd psana_examples.DumpPrinceton psana_examples.DumpPulnix psana_examples.DumpQuartz psana_examples.DumpTimepix psana_examples.DumpUsdUsb")
else:
  cfg.write("modules = psana_examples.DumpEpics")

if dumpEpics:
  cfg.write(" psana_examples.DumpEpics")
if dumpRayonix:
  cfg.write(" psana_examples.DumpRayonix")
if dumpEpix:
  cfg.write(" psana_examples.DumpEpixSampler")
cfg.write("\n")
cfg.file.flush()

psana_cmd = 'psana -c %s %s' % (cfg.name, ' '.join(psanaArgs))
os.system(psana_cmd)


